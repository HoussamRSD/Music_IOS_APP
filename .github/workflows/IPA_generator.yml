name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: ðŸŽ‰ iOS IPA Build
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Show environment diagnostics
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          flutter --version
          xcodebuild -version || true
          which pod || true
          pod --version || true

      - name: Flutter pub get
        run: flutter pub get

      - name: Update CocoaPods repo
        run: pod repo update
        working-directory: ios

      - name: Build IPA (no code signing, verbose)
        run: |
          set -x
          export CODE_SIGNING_ALLOWED=NO
          export CODE_SIGNING_REQUIRED=NO
          export CODE_SIGN_IDENTITY=""
          flutter pub get
          flutter build ipa --release --no-codesign -v
        timeout-minutes: 60

      - name: Create IPA (use built .ipa or fallback)
        run: |
          set -e
          echo "Listing build/ios contents for debugging"
          ls -la build/ios || true
          ls -la build/ios/ipa || true
          # If flutter produced an .ipa, use it. Otherwise fall back to zipping the Runner.app
          if [ -f build/ios/ipa/Runner.ipa ]; then
            echo "Found build/ios/ipa/Runner.ipa â€” copying to FlutterIpaExport.ipa"
            cp build/ios/ipa/Runner.ipa FlutterIpaExport.ipa
            ls -lh FlutterIpaExport.ipa
          else
            echo "Runner.ipa not found â€” falling back to zipping Payload from Runner.app"
            mkdir -p Payload
            cp -r build/ios/iphoneos/Runner.app Payload/
            zip -r -q FlutterIpaExport.ipa Payload
            ls -lh FlutterIpaExport.ipa
          fi
        working-directory: ./

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: FlutterIpaExport.ipa
          retention-days: 7
