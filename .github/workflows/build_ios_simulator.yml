name: Build iOS (simulator, no signing)

on:
    workflow_dispatch:

jobs:
    build:
        runs-on: macos-14
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: stable
                  cache: true

            - name: Flutter pub get
              run: flutter pub get

            # Build for iOS Simulator (no signing required)
            # We explicitly disable code signing requirements for the build command
            - name: Build iOS simulator app
              run: |
                  export CODE_SIGNING_ALLOWED=NO
                  export CODE_SIGNING_REQUIRED=NO
                  export CODE_SIGN_IDENTITY=""
                  flutter build ios --simulator --no-codesign

            # Package the .app for download (zip is simplest)
            - name: Package simulator app
              run: |
                  # Finding the app path dynamically to be safe
                  APP_PATH=$(find build/ios -name "Runner.app" -type d | head -n 1)

                  if [ -z "$APP_PATH" ]; then
                    echo "Runner.app not found!"
                    find build/ios -maxdepth 4 -type d -name "*.app" -print
                    exit 1
                  fi

                  echo "Found app at: $APP_PATH"
                  ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" Music_IOS_App-simulator.zip

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ios-simulator-app
                  path: Music_IOS_App-simulator.zip
